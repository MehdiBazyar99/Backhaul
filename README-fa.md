# EasyBackhaul: اسکریپت نصب و مدیریت آسان Backhaul

![Version](https://img.shields.io/badge/Version-13.0--beta-blue.svg)
![License](https://img.shields.io/badge/License-AGPL--3.0-brightgreen.svg)
![Maintained](https://img.shields.io/badge/maintained%3F-yes-green.svg)
![Features](https://img.shields.io/badge/Features-مدیریت%20پیشرفته%20%7C%20ریستارت%20هوشمند%20%7C%20اعتبارسنجی%20بهبود%20یافته%20%7C%20نظارت%20بر%20سلامت%20سیستم-orange.svg)

[**English Document (نسخه انگلیسی)**](./README.md)

به **EasyBackhaul** خوش آمدید! یک اسکریپت ماژولار، کاربرپسند و قدرتمند برای مدیریت [Backhaul](https://github.com/Musixal/Backhaul). این ابزار نصب، پیکربندی و مدیریت روزانه بک‌هاول را بسیار ساده و سریع می‌کند.

توسعه یافته توسط [@N4Xon (NaxonM)](https://github.com/NaxonM/EasyBackhaul)، EasyBackhaul یک رابط منویی قوی برای مدیریت پروژه اصلی بک‌هاول (Musixal) فراهم می‌کند.

---

## 🚀 امکانات

### **مدیریت اصلی**
- **ساختار ماژولار**: نگهداری و توسعه آسان از طریق پوشه `modules/` و اسکریپت `build.sh`
- **جادوگر پیکربندی راهنما**: برای سرور و کلاینت، با راهنمای متنی در هر مرحله
- **نمایش لاگ تعاملی**: اسکرول، جستجو و دنبال‌کردن لاگ زنده — خروج امن با Ctrl+C
- **مدیریت خودکار وابستگی‌ها، UFW و systemd**
- **مدیریت گواهی TLS**: تولید و استفاده از گواهی خودامضا برای تونل‌های امن

### **امکانات پیشرفته**
- **ریستارت هوشمند**: ریستارت هماهنگ با بررسی سلامت، نظارت بر منابع و بازیابی خطا
- **اعتبارسنجی پیشرفته کانفیگ**: اعتبارسنجی جامع با گزارش‌دهی دقیق خطاها
- **ناظر ریستارت هماهنگ**: هماهنگی پیشرفته ریستارت بین کلاینت و سرور
- **راه‌اندازی خودکار با کرون**: تنظیم یا حذف کرون‌جاب برای پایداری بیشتر
- **نظارت بر عملکرد**: پیگیری عملکرد عملیات و استفاده از منابع
- **نظارت بر سلامت**: بررسی‌های سلامت تونل در زمان واقعی با نظارت بر منابع
- **نظارت بر سلامت و عملکرد سیستم**: نظارت جامع سیستم و بهینه‌سازی
- **پاک‌سازی فرآیندهای زامبی**: پاک‌سازی خودکار فرآیندهای یتیم و ناظران

### **تجربه کاربری**
- **مدیریت پیشرفته خطا**: پیام‌های واضح و رنگی با پیش‌فرض‌های امن
- **شاخص‌های پیشرفت**: بازخورد بصری برای عملیات طولانی با انیمیشن‌های چرخشی
- **اعتبارسنجی ورودی**: اعتبارسنجی قوی با درخواست مجدد برای ورودی نامعتبر
- **راهنمای متنی**: فشار دادن `?` برای راهنما در سراسر رابط
- **مستندات دو زبانه**: انگلیسی و فارسی
- **کانال بتا**: دریافت آخرین امکانات پیش از انتشار پایدار
- **جادوگر نصب**: گزینه‌های متعدد نصب با تشخیص شبکه

### **امنیت و عملکرد**
- **عملیات امن فایل**: حذف امن و سخت‌سازی مجوزها
- **بهینه‌سازی منابع**: بهینه‌سازی اولویت فرآیند و مدیریت حافظه
- **محدودیت نرخ**: محافظت در برابر عملیات سریع
- **پاک‌سازی ورودی**: مدیریت امن ورودی کاربر
- **چرخش لاگ**: مدیریت خودکار لاگ و چرخش
- **سخت‌سازی مجوزها**: سخت‌سازی خودکار امنیت فایل‌های کانفیگ و پوشه‌ها

### **ثبت و نظارت**
- **سیستم ثبت پیشرفته**: فرمت‌های JSON و متنی با سطوح قابل تنظیم
- **مدیریت سطح لاگ**: تغییرات پویای سطح لاگ (debug/info/warn/error)
- **ثبت سلامت**: فایل‌های لاگ اختصاصی سلامت و عملکرد
- **ثبت حسابرسی**: مسیر حسابرسی جامع تمام عملیات
- **نمایشگر فایل لاگ**: مرور تعاملی فایل‌های لاگ با قابلیت جستجو

---

## 🛠️ نصب و شروع سریع

**پیشنهادی:**  
مخزن را کلون و اسکریپت را از سورس بسازید:

```bash
git clone https://github.com/yourusername/EasyBackhaul.git
cd EasyBackhaul
./build.sh
sudo bash EasyBackhaul.sh
```

**یا:**  
آخرین نسخه [easybackhaul.sh](./easybackhaul.sh) را دانلود و اجرا کنید:

```bash
sudo bash easybackhaul.sh
```

---

## 📝 راهنمای استفاده: گام به گام

### ۱. جادوگر نصب

اسکریپت با جادوگر نصب شروع می‌شود که گزینه‌های متعددی ارائه می‌دهد:
- **دانلود خودکار از گیت‌هاب** (پیشنهادی): دانلود آخرین باینری Backhaul از گیت‌هاب
- **نصب از فایل محلی**: نصب از فایل باینری محلی backhaul
- **منبع دانلود جایگزین**: استفاده از منابع دانلود جایگزین در صورت عدم دسترسی به گیت‌هاب
- **تشخیص شبکه**: تست اتصال شبکه و تشخیص مشکلات
- **رد نصب** (پیشرفته): رد نصب باینری برای کاربران پیشرفته

### ۲. منوی اصلی

پس از نصب، منوی زیر را خواهید دید:

```
      EasyBackhaul Installer & Management Menu (v13.0-beta)
================================================================
  Core by Musixal  |  Installer by @N4Xon
----------------------------------------------------------------
 1. Configure a New Tunnel
 2. Manage Existing Tunnels
 3. Update/Re-install Backhaul Binary
 4. Generate Self-Signed TLS Certificate
 5. Select Backhaul Binary Directory (current: /usr/local/bin/backhaul)
 6. System Health & Performance Monitor
 7. Clean Up Zombie/Orphaned Processes
 8. Uninstall EasyBackhaul (Removes binary and ALL configs)
 ?. Help & Documentation
 0. Exit
----------------------------------------------------------------
```

### ۳. ساخت تونل جدید

- **پیکربندی سریع (پیشنهادی)**: استفاده از پیش‌فرض‌های منطقی و پرسش فقط سوالات ضروری
- **پیکربندی پیشرفته**: کنترل کامل روی تمام تنظیمات برای کاربران حرفه‌ای
- **انتخاب هوشمند پروتکل**: گزینه‌های ساده‌شده با توضیحات واضح
- **پیکربندی ساده پورت‌ها**: وارد کردن پورت‌ها به صورت تکی، چندتایی یا محدوده (مثل `80,443,8000-8010`)
- **بررسی خودکار**: بررسی آزاد بودن پورت، اعتبارسنجی IP و تست پینگ اختیاری
- **اعتبارسنجی پیشرفته ورودی**: اعتبارسنجی قوی با پیام‌های خطای مفید

### ۴. مدیریت تونل‌های موجود

#### **منوی مدیریت تونل**
- **شروع/توقف/ریستارت**: کنترل پایه سرویس
- **ریستارت هوشمند**: ریستارت پیشرفته با بررسی سلامت و نظارت بر منابع
- **مشاهده وضعیت سرویس**: خلاصه و لاگ‌های اخیر
- **مشاهده لاگ کامل**: مشاهده تعاملی لاگ با گزینه‌های اسکرول/جستجو/دنبال‌کننده
- **مشاهده کانفیگ**: نمایش کانفیگ فعلی تونل
- **ویرایش کانفیگ**: ویرایش با nano و امکان ریستارت
- **تغییر سطح لاگ**: تغییر سطح لاگ (debug/info/warn/error)
- **تست اتصال**: تست واقعی اتصال شبکه
- **هات‌ریلود کانفیگ**: بارگذاری مجدد کانفیگ بدون ریستارت
- **مدیریت کرون ریستارت خودکار**: تنظیم ریستارت خودکار
- **مدیریت ناظر ریستارت هماهنگ**: هماهنگی پیشرفته ریستارت
- **بررسی سلامت و عملکرد**: نظارت بر سلامت تونل و عملکرد
- **اعتبارسنجی کانفیگ**: اعتبارسنجی جامع کانفیگ
- **حذف سرویس**: حذف تونل و تمام فایل‌های مرتبط

#### **ویژگی ریستارت هوشمند**
- **بررسی سلامت پیش از ریستارت**: تأیید وضعیت فعلی تونل
- **نظارت بر منابع سیستم**: بررسی استفاده از حافظه، CPU و دیسک
- **ریستارت هماهنگ**: توقف سرویس، انتظار برای خنک‌شدن، ریستارت با تلاش مجدد
- **تأیید پس از ریستارت**: تأیید سلامت تونل پس از ریستارت
- **بازیابی خطا**: گزینه‌های بازیابی خودکار در صورت شکست ریستارت
- **شاخص‌های پیشرفت**: بازخورد بصری در طول فرآیند ریستارت

#### **اعتبارسنجی پیشرفته کانفیگ**
- **اعتبارسنجی جامع**: بررسی نحو، فیلدهای ضروری و تنظیمات خاص پروتکل
- **گزارش‌دهی دقیق خطا**: پیام‌های خطای واضح با مشکلات خاص
- **پشتیبانی از تمام پروتکل‌ها**: TCP، UDP، WebSocket، WSS، TCP Multiplexing، WSMUX، WSSMUX
- **تشخیص تضاد پورت**: شناسایی تضادهای احتمالی پورت
- **اعتبارسنجی امنیت**: بررسی مشکلات امنیتی و فیلدهای منسوخ

#### **نمایش لاگ تعاملی**
- انتخاب بین حالت زنده یا اسکرول/جستجو
- **با Ctrl+C** از لاگ خارج و به منو بازگردید (اسکریپت بسته نمی‌شود)
- **عملکرد جستجو**: استفاده از `/` برای جستجو در لاگ‌ها
- **حالت دنبال‌کننده**: استفاده از `F` برای دنبال‌کردن لاگ‌ها در زمان واقعی

#### **ناظر ریستارت هماهنگ**
- **فرآیند پس‌زمینه**: اجرا به عنوان فرآیند سبک پس‌زمینه
- **هماهنگی ریستارت**: هماهنگی ریستارت بین کلاینت و سرور
- **قابل تنظیم**: شخصی‌سازی الگوها، تأخیرها و پورت‌ها
- **نظارت بر وضعیت**: مشاهده وضعیت ناظر و لاگ‌ها
- **تست**: تست ارتباط ناظر

### ۵. نظارت بر سلامت و عملکرد سیستم

#### **نمای کلی سیستم**
- **وضعیت باینری**: بررسی نصب و نسخه باینری Backhaul
- **وضعیت سرویس**: نظارت بر تمام سرویس‌های در حال اجرای Backhaul
- **استفاده از منابع**: استفاده از CPU، حافظه و دیسک در زمان واقعی
- **اندازه فایل‌های لاگ**: نظارت بر رشد و چرخش فایل‌های لاگ

#### **عملیات موجود**
- **تازه‌سازی وضعیت سلامت**: به‌روزرسانی تمام معیارهای سیستم
- **پاک‌سازی فرآیندهای زامبی**: حذف فرآیندهای یتیم و ناظران
- **مشاهده لاگ‌های تفصیلی**: مرور و جستجو در فایل‌های لاگ
- **بهینه‌سازی تمام فرآیندهای تونل**: بهینه‌سازی استفاده از منابع برای تمام تونل‌ها

### ۶. ویژگی‌های مدیریت پیشرفته

#### **مدیریت سطح لاگ**
- **تغییرات پویای سطح لاگ**: تغییر سطح لاگ بدون ریستارت
- **سطوح پشتیبانی شده**: debug، info، warn، error
- **ریستارت خودکار**: گزینه ریستارت سرویس پس از تغییر سطح لاگ
- **نمایش سطح فعلی**: نمایش سطح لاگ فعلی برای هر تونل

#### **پاک‌سازی فرآیندهای زامبی**
- **تشخیص خودکار**: یافتن فرآیندهای یتیم و ناظران
- **خاتمه امن**: خاموشی آرام با بازگشت به کشتن اجباری
- **پاک‌سازی جامع**: حذف فایل‌های PID، لاگ‌ها و فایل‌های موقت
- **بهینه‌سازی سیستم**: پاک‌سازی منابع سیستم

#### **مدیریت باینری**
- **شخصی‌سازی مسیر**: تغییر مکان باینری Backhaul
- **بررسی نسخه**: نمایش نسخه و وضعیت باینری
- **نصب مجدد**: به‌روزرسانی یا نصب مجدد باینری Backhaul
- **پایداری جلسه**: به خاطر سپردن مسیر باینری برای جلسه فعلی

---

## 🔧 امکانات پیشرفته

### **نظارت بر عملکرد**
- **پیگیری عملیات**: نظارت بر عملکرد تمام عملیات
- **استفاده از منابع**: پیگیری استفاده از حافظه، CPU و دیسک
- **تشخیص عملیات کند**: شناسایی عملیات‌هایی که بیش از حد انتظار طول می‌کشند
- **بهینه‌سازی عملکرد**: بهینه‌سازی خودکار اولویت فرآیند

### **نظارت بر سلامت**
- **بررسی‌های سلامت در زمان واقعی**: نظارت بر وضعیت سلامت تونل
- **نظارت بر منابع**: پیگیری استفاده از حافظه و CPU برای هر تونل
- **ثبت سلامت**: ثبت معیارهای سلامت برای تحلیل
- **بازیابی خودکار**: تلاش برای بازیابی تونل‌های شکست‌خورده

### **ویژگی‌های امنیتی**
- **عملیات امن فایل**: حذف امن و سخت‌سازی مجوزها
- **پاک‌سازی ورودی**: محافظت در برابر ورودی مخرب
- **محدودیت نرخ**: جلوگیری از سوء استفاده از رابط مدیریت
- **ثبت حسابرسی**: مسیر حسابرسی جامع تمام عملیات
- **سخت‌سازی مجوزها**: سخت‌سازی خودکار امنیت فایل‌ها و پوشه‌ها

### **مدیریت خطا و بازیابی**
- **بازیابی پیشرفته خطا**: بازیابی خودکار برای مشکلات رایج
- **مکانیزم‌های تلاش مجدد**: پس‌رفت نمایی برای عملیات شکست‌خورده
- **تخریب آرام**: ادامه عملیات حتی با شکست‌های جزئی
- **ثبت خطا**: ثبت دقیق خطا برای عیب‌یابی

### **سیستم ثبت پیشرفته**
- **فرمت‌های متعدد**: فرمت‌های ثبت JSON و متنی
- **سطوح قابل تنظیم**: سطوح DEBUG، INFO، WARN، ERROR
- **چرخش لاگ**: چرخش و فشرده‌سازی خودکار لاگ
- **فایل‌های لاگ اختصاصی**: فایل‌های جداگانه برای سلامت، عملکرد و لاگ‌های عمومی
- **مشاهده تعاملی**: مشاهده پیشرفته لاگ با قابلیت جستجو و دنبال‌کننده

---

## 🧑‍💻 توسعه و ساخت

### **معماری ماژولار**
- تمام منطق در پوشه `modules/` ماژولار شده است
- با اجرای `./build.sh` اسکریپت نهایی `easybackhaul.sh` ساخته می‌شود
- **مستقیم فایل easybackhaul.sh را ویرایش نکنید** — ماژول‌ها را ویرایش و مجدد بسازید

### **ساختار ماژول‌ها**
```
modules/
├── backhaul_core.sh      # عملیات اصلی Backhaul
├── config.sh            # مدیریت کانفیگ
├── cron.sh              # مدیریت کرون جاب
├── globals.sh           # متغیرهای سراسری و تنظیمات
├── helpers.sh           # توابع کمکی و ابزارها
├── menu.sh              # منوی اصلی و رابط کاربری
├── prereqs.sh           # پیش‌نیازها و وابستگی‌ها
├── restart_watcher.sh   # ناظر ریستارت هماهنگ
├── systemd.sh           # مدیریت سرویس systemd
├── tunnel_mgmt.sh       # مدیریت تونل
├── ufw.sh               # مدیریت فایروال UFW
└── validation.sh        # اعتبارسنجی کانفیگ
```

### **ساخت از سورس**
```bash
# کلون کردن مخزن
git clone https://github.com/NaxonM/EasyBackhaul.git
cd EasyBackhaul

# ساخت اسکریپت
./build.sh

# اسکریپت آماده استفاده است
sudo bash easybackhaul.sh
```

---

## 🧪 کانال بتا

این نسخه از طریق **کانال بتا** منتشر شده است.  
لطفاً باگ‌ها و بازخوردها را از طریق [Issues گیت‌هاب](https://github.com/NaxonM/EasyBackhaul/issues) ارسال کنید.

### **بهبودهای اخیر**
- ✅ **ریستارت هوشمند**: ریستارت پیشرفته با بررسی سلامت و نظارت بر منابع
- ✅ **اعتبارسنجی بهبود یافته**: اعتبارسنجی جامع کانفیگ با گزارش‌دهی دقیق
- ✅ **تجربه کاربری بهبود یافته**: شاخص‌های پیشرفت، پیام‌های خطای بهتر و راهنمای متنی
- ✅ **نظارت بر عملکرد**: پیگیری عملکرد عملیات و استفاده از منابع
- ✅ **بهبودهای امنیتی**: عملیات امن فایل و پاک‌سازی ورودی
- ✅ **بازیابی خطا**: مدیریت پیشرفته خطا و مکانیزم‌های بازیابی
- ✅ **ناظر ریستارت هماهنگ**: هماهنگی پیشرفته ریستارت بین کلاینت و سرور
- ✅ **نظارت بر سلامت سیستم**: نظارت جامع سیستم و بهینه‌سازی
- ✅ **پاک‌سازی فرآیندهای زامبی**: پاک‌سازی خودکار فرآیندهای یتیم
- ✅ **ثبت پیشرفته**: سیستم ثبت پیشرفته با فرمت‌های متعدد و سطوح
- ✅ **جادوگر نصب**: گزینه‌های متعدد نصب با تشخیص شبکه
- ✅ **مدیریت سطح لاگ**: تغییرات پویای سطح لاگ برای عیب‌یابی

---

## 🙏 سازندگان و حامیان

- **پروژه اصلی Backhaul**: [Musixal](https://github.com/Musixal/Backhaul)
- **اسکریپت EasyBackhaul**: [@N4Xon (NaxonM)](https://github.com/NaxonM/EasyBackhaul) ([تلگرام](https://t.me/N4Xon))

---

## 📄 لایسنس

پروژه اصلی Backhaul تحت لایسنس AGPL-3.0 منتشر شده است.

---

**برای مستندات انگلیسی به [README.md](./README.md) مراجعه کنید.**
